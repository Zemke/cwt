<div *ngIf="!gameWasPlayed" class="alert alert-info">
    This game hasn’t been played yet.
</div>

<div *ngIf="game && gameWasPlayed">
    <span class="float-right text-right">
        Reported by
        <cwt-user [username]="game.reporter.username"></cwt-user><br>
        <cwt-time-ago [date]="game.reportedAt"></cwt-time-ago>
    </span>

    <h1>
        <cwt-user [username]="game.homeUser.username"></cwt-user>
        {{game.scoreHome}}–{{game.scoreAway}}
        <cwt-user [username]="game.awayUser.username"></cwt-user>
    </h1>

    <div class="row mt-1">
        <div class="col-12">
            <a [routerLink]="game.tournament.status === 'FINISHED' ? ['/archive', (game.tournament.created | cwtDate:'y')] : ['/playoffs']"
               [fragment]="game.tournament.status === 'FINISHED' ? 'playoffs': undefined"
               *ngIf="game.playoff" class="btn btn-primary btn text-white w-100 all-petite-caps " i18n>
                <span class="font-weight-bold">
                    {{game.playoffRoundLocalized}}
                </span>
                {{game.tournament.created | cwtDate:'y'}}
            </a>
            <a [routerLink]="game.tournament.status === 'FINISHED' ? ['/archive', (game.tournament.created | cwtDate:'y')] : ['/groups']"
               [fragment]="game.tournament.status === 'FINISHED' ? game.group.label : undefined"
               class="btn btn-secondary btn text-white w-100 all-petite-caps" *ngIf="game.group">
                <span class="font-weight-bold">
                    Group {{game.group.label}}
                </span>
                {{game.tournament.created | cwtDate:'y'}}
            </a>
        </div>
    </div>

    <div class="mt-3" *ngIf="game.voided || game.tournament.status === 'FINISHED' || (hasOlderVersion && waVersionWarn)">
        <div class="alert alert-warning mt-1" role="alert"
             *ngIf="game.voided">
            <i class="fa fa-warning"></i>
            This game has been voided.
        </div>
        <div class="alert alert-warning mt-1" role="alert"
             *ngIf="game.tournament.status === 'FINISHED'">
            <i class="fa fa-warning"></i>
            This game is from a past tournament.
        </div>
        <div class="alert alert-danger mt-1" role="alert"
             *ngIf="hasOlderVersion">
            <i class="fa fa-exclamation-triangle"></i>
            The game was played with an older version.
            <a target="_blank"
               href="https://worms2d.info/files/WA_update-3.8_%5BCD%5D_Installer.exe">
                Download WA 3.8 <i class="fa fa-external-link"></i>
            </a>
        </div>
    </div>

    <div class="bet-result mt-4" *ngIf="betResult">
        <div class="bet-result-home" [ngStyle]="{'width': betResult.homeUserPercent + '%'}">
            <ng-template #betsForHome>
                <span *ngFor="let user of betResult.homeUser; let last = last"><cwt-user [username]="user.user.username"></cwt-user><span *ngIf="!last">, </span></span>
                <span *ngIf="!betResult.homeUser.length">No bets were placed.</span>
            </ng-template>
            <a [routerLink]="" [ngbPopover]="betsForHome" placement="left" class="d-none d-sm-inline-block">
                {{betResult.homeUser.length}}
            </a>
            <a [routerLink]="" [ngbPopover]="betsForHome" placement="bottom" class="d-sm-none">
                {{betResult.homeUser.length}}
            </a>
        </div>
        <div class="bet-result-away" [ngStyle]="{'width': betResult.awayUserPercent + '%'}">
            <ng-template #betsForAway>
                <span *ngFor="let user of betResult.awayUser; let last = last"><cwt-user [username]="user.user.username"></cwt-user><span *ngIf="!last">, </span></span>
                <span *ngIf="!betResult.awayUser.length">No bets were placed.</span>
            </ng-template>
            <a [routerLink]="" [ngbPopover]="betsForAway" placement="right" class="d-none d-sm-inline-block">
                {{betResult.awayUser.length}}
            </a>
            <a [routerLink]="" [ngbPopover]="betsForAway" placement="bottom" class="d-sm-none">
                {{betResult.awayUser.length}}
            </a>
        </div>
    </div>

    <div class="row mt-4 no-gutters">
        <div class="col-12 col-md-5 col-lg-4 mb-1 mb-md-0 pr-md-0">
            <div class="btn-group w-100">
                <button class="w-100 btn btn-success text-white" (click)="rate('LIKE')" ngbTooltip="Like"
                        [disabled]="['LIKE', 'DISLIKE'].indexOf(submittingRating) !== -1 || !authenticatedUser || authenticatedUserRatings.indexOf('LIKE') !== -1 || authenticatedUserRatings.indexOf('DISLIKE') !== -1">
                    <i class="fa fa-user" *ngIf="authenticatedUserRatings.indexOf('LIKE') !== -1"></i>&nbsp;
                    <ng-container *ngIf="submittingRating !== 'LIKE'">
                        Like&nbsp;
                        <span class="font-variant-none font-weight-bold">{{ratings.LIKE.length}}</span>
                    </ng-container>
                    <img src="../../img/loading.gif" class="loading" *ngIf="submittingRating === 'LIKE'"/>
                </button>
                <button class="w-100 btn btn-danger text-white" (click)="rate('DISLIKE')"
                        ngbTooltip="Dislike"
                        [disabled]="['LIKE', 'DISLIKE'].indexOf(submittingRating) !== -1 || !authenticatedUser || authenticatedUserRatings.indexOf('DISLIKE') !== -1 || authenticatedUserRatings.indexOf('LIKE') !== -1">
                    <i class="fa fa-user" *ngIf="authenticatedUserRatings.indexOf('DISLIKE') !== -1"></i>&nbsp;
                    <ng-container *ngIf="submittingRating !== 'DISLIKE'">
                        Dislike&nbsp;
                        <span class="font-variant-none font-weight-bold">{{ratings.DISLIKE.length}}</span>
                    </ng-container>
                    <img src="../../img/loading.gif" class="loading" *ngIf="submittingRating === 'DISLIKE'"/>
                </button>
            </div>
        </div>
        <div class="col-12 col-md-5 col-lg-4 mb-1 mb-md-0 pl-md-1 pr-md-1">
            <div class="btn-group w-100">
                <button class="w-100 btn bg-danger text-white" (click)="rate('LIGHTSIDE')"
                        ngbTooltip="Aggressive playing"
                        [disabled]="['LIGHTSIDE', 'DARKSIDE'].indexOf(submittingRating) !== -1 || !authenticatedUser || authenticatedUserRatings.indexOf('LIGHTSIDE') !== -1 || authenticatedUserRatings.indexOf('DARKSIDE') !== -1">
                    <i class="fa fa-user" *ngIf="authenticatedUserRatings.indexOf('LIGHTSIDE') !== -1"></i>&nbsp;
                    <ng-container *ngIf="submittingRating !== 'LIGHTSIDE'">
                        Ligthside&nbsp;
                        <span class="font-variant-none font-weight-bold">{{ratings.LIGHTSIDE.length}}</span>
                    </ng-container>
                    <img src="../../img/loading.gif" class="loading" *ngIf="submittingRating === 'LIGHTSIDE'"/>
                </button>
                <button class="w-100 btn bg-success text-white" (click)="rate('DARKSIDE')"
                        ngbTooltip="Thoughtful playing"
                        [disabled]="['LIGHTSIDE', 'DARKSIDE'].indexOf(submittingRating) !== -1 || !authenticatedUser || authenticatedUserRatings.indexOf('DARKSIDE') !== -1 || authenticatedUserRatings.indexOf('LIGHTSIDE') !== -1">
                    <i class="fa fa-user" *ngIf="authenticatedUserRatings.indexOf('DARKSIDE') !== -1"></i>&nbsp;
                    <ng-container *ngIf="submittingRating !== 'DARKSIDE'">
                        Darkside&nbsp;
                        <span class="font-variant-none font-weight-bold">{{ratings.DARKSIDE.length}}</span>
                    </ng-container>
                    <img src="../../img/loading.gif" class="loading" *ngIf="submittingRating === 'DARKSIDE'"/>
                </button>
            </div>
        </div>
        <div class="col-6 col-md-1 col-lg-2 pr-1 pr-md-0">
            <button class="btn btn-primary btn text-white w-100"
                    [ngClass]="{'active': showRatings}" (click)="showRatings = !showRatings">
                <span class="d-inline d-md-none d-lg-inline">Ratings</span>
                <span class="d-none d-md-inline d-lg-none"><i class="fa fa-star"></i></span>
            </button>
        </div>
        <div class="col-6 col-md-1 col-lg-2 pl-1">
            <span *ngIf="game.techWin" class="btn btn-primary text-white w-100">
                <span class="d-inline d-md-none d-lg-inline">Tech. Win</span>
                <span class="d-none d-md-inline d-lg-none" ngbTooltip="Tech. Win"><i class="fa fa-gavel"></i></span>
            </span>
            <a *ngIf="!game.techWin" [href]="game.id | cwtReplayLink"
               class="btn btn-primary text-white w-100">
                <span class="d-inline d-md-none d-lg-inline">Download</span>
                <span class="d-none d-md-inline d-lg-none"><i class="fa fa-download"></i></span>
            </a>
            <span *ngIf="game.techWin" class="btn btn-primary text-white w-100">
                <span class="d-inline d-md-none d-lg-inline">Tech. Win</span>
                <span class="d-none d-md-inline d-lg-none" ngbTooltip="Tech. Win"><i class="fa fa-gavel"></i></span>
            </span>
        </div>
    </div>
    <div [hidden]="!showRatings">
        <div class="row no-gutters popdown">
            <div class="offset-md-10 offset-lg-8 col-6 col-md-1 col-lg-2 text-center pr-1 pr-md-0">
                <i class="fa fa-2x fa-caret-up text-light"></i>
            </div>
        </div>
        <div class="row">
            <div class="col-12 col-md-8 offset-md-3 col-lg-7">
                <div class="card bg-light">
                    <div class="card-body" *ngIf="!game.ratings.length">
                        There are no ratings.
                    </div>
                    <div class="card-body" *ngIf="game.ratings.length">
                        <div *ngIf="ratings.LIKE.length" class="mb-1">
                            Liked by
                            <span *ngFor="let rating of ratings.LIKE; let last = last">
                                <cwt-user [username]="rating.user.username"></cwt-user><span *ngIf="!last">, </span>
                            </span>
                        </div>
                        <div *ngIf="ratings.DISLIKE.length" class="mb-1">
                            Disliked by
                            <span *ngFor="let rating of ratings.DISLIKE; let last = last">
                                <cwt-user [username]="rating.user.username"></cwt-user><span *ngIf="!last">, </span>
                            </span>
                        </div>
                        <div *ngIf="ratings.LIGHTSIDE.length" class="mb-1">
                            Rated “ligthside” by
                            <span *ngFor="let rating of ratings.LIGHTSIDE; let last = last">
                                <cwt-user [username]="rating.user.username"></cwt-user><span *ngIf="!last">, </span>
                            </span>
                        </div>
                        <div *ngIf="ratings.DARKSIDE.length" class="mb-1">
                            Rated “darkside” by
                            <span *ngFor="let rating of ratings.DARKSIDE; let last = last">
                                <cwt-user [username]="rating.user.username"></cwt-user><span *ngIf="!last">, </span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row mt-4">
        <div class="col-12 col-md-6 col-lg-5 col-xl-4 text-center">
            <img *ngIf="loadingStats" src="../../img/loading.gif"/>
            <div *ngIf="!stats.length && statsAreBeingProcessed && !loadingStats"
                 class="alert alert-info text-left">
                The replay files are currently being processed to show further statistics.<br>
                They will appear here automatically as they’re available.
            </div>
            <ng-container *ngIf="stats.length">
                <button class="btn btn-sm rounded-circle text-center text-white mb-2 mr-2 p-0"
                        [ngClass]="statsForRound === index + 1 ? 'bg-secondary' : 'bg-primary'"
                        [style.height]="'2.5rem'" [style.width]="'2.5rem'" [style.fontSize]="'1.5rem'"
                        *ngFor="let s of stats; let index = index" [ngbTooltip]="'Round ' + (index + 1)" placement="top"
                        (click)="statsForRound = index + 1">
                    {{index + 1}}
                </button>
                <cwt-game-stats *ngIf="stats[statsForRound - 1]" [stats]="stats[statsForRound - 1]"></cwt-game-stats>
            </ng-container>
        </div>
        <div [ngClass]="stats.length || statsAreBeingProcessed ? 'col-12 col-md-6 col-lg-7 col-xl-8 mt-4 mt-md-0' : 'col-12'">
            <div class="row mb-2" *ngIf="stats.length">
                <div class="col-md-12 text-right">
                    <div [(ngModel)]="rightColumnViewToggle" class="btn-group btn-group-toggle" name="viewMode"
                         ngbRadioGroup>
                        <label class="btn-primary" ngbButtonLabel>
                            <input [value]="'COMMENTS'" ngbButton type="radio">
                            Comments
                        </label>
                        <label class="btn-primary" ngbButtonLabel>
                            <input [value]="'IN_GAME_CHAT'" ngbButton type="radio">
                            In-game chat
                        </label>
                        <label class="btn-primary" ngbButtonLabel>
                            <input [value]="'MAPS'" ngbButton type="radio">
                            Maps
                        </label>
                    </div>
                </div>
            </div>
            <div *ngIf="rightColumnViewToggle === 'COMMENTS'" class="row">
                <div class="col-12 mb-2" *ngIf="authenticatedUser">
                    <div class="card bg-secondary p-1">
                        <form #commentForm="ngForm" (ngSubmit)="submitComment()">
                            <textarea (keyup.control.enter)="commentForm.onSubmit($event)" [(ngModel)]="newComment.body"
                                      class="form-control" name="comment"
                                      placeholder="Write a comment…" required
                                      rows="3">
                            </textarea>
                            <div class="float-right">
                                <button class="btn btn-primary mt-1" style="width: 80px"
                                        [disabled]="!commentForm.form.valid || submittingComment">
                                    <img src="../../img/loading.gif" class="loading" *ngIf="submittingComment"/>
                                    <ng-container *ngIf="!submittingComment">Submit</ng-container>
                                </button>
                            </div>
                        </form>
                        <div class="clearfix"></div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="card bg-secondary text-white border-0">
                        <div class="card-body" *ngFor="let comment of game.comments"
                             style="border-bottom: 1px solid white !important;">
                            <cwt-time-ago [date]="comment.created"
                                          class="float-none float-sm-right float-md-none float-lg-right"></cwt-time-ago>
                            <h4 class="card-title">
                                <cwt-user [username]="comment.author.username"></cwt-user>
                            </h4>
                            <p class="card-text rendered-text links-red"
                               [innerHTML]="comment.body | cwtConvertLinks"></p>
                        </div>
                    </div>
                    <div class="alert alert-info" role="alert" *ngIf="!game.comments.length">
                        There are no comments yet.
                    </div>
                </div>
            </div>
            <div *ngIf="rightColumnViewToggle === 'IN_GAME_CHAT'" class="row">
                <div class="col-12">
                    <div class="card bg-secondary text-white border-0">
                        <div *ngFor="let stat of stats; let index = index"
                             class="card-body"
                             style="border-bottom: 1px solid white !important;">
                            <h4 class="card-title">Round {{index + 1}}</h4>
                            <p *ngFor="let message of stat.messages" class="inGameChat">
                                [{{message.user}}] {{message.body}}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div *ngIf="rightColumnViewToggle === 'MAPS'" class="row">
                <div class="col-12">
                    <div class="card bg-secondary text-white border-0">
                        <div *ngFor="let stat of stats; let index = index"
                             class="card-body"
                             style="border-bottom: 1px solid white !important;">
                            <h4 class="card-title">Round {{index + 1}}</h4>

                            <cwt-map [map]="stat.map" [gameId]="game.id"></cwt-map>
                </div>
            </div>
        </div>
    </div>
</div>
