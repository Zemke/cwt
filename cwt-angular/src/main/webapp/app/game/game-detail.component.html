<div *ngIf="game">
    <span class="float-right text-right">
        Reported by
        <cwt-user [username]="game.reporter.username"></cwt-user><br>
        <cwt-time-ago [date]="game.created"></cwt-time-ago>
    </span>

    <h1>
        <cwt-user [username]="game.homeUser.username"></cwt-user>
        {{game.scoreHome}}–{{game.scoreAway}}
        <cwt-user [username]="game.awayUser.username"></cwt-user>
    </h1>

    <div class="row mt-1">
        <div class="col-12">
            <a [routerLink]="game.tournament.status === 'FINISHED' ? ['/archive', (game.tournament.created | date:'y')] : ['/playoffs']"
               [fragment]="game.tournament.status === 'FINISHED' ? 'playoffs': undefined"
               *ngIf="game.playoff" class="btn btn-primary btn text-white w-100 all-petite-caps " i18n>
                <span class="font-weight-bold">
                    {{game.playoffRoundLocalized}}
                </span>
                {{game.tournament.created | date:'y'}}
            </a>
            <a [routerLink]="game.tournament.status === 'FINISHED' ? ['/archive', (game.tournament.created | date:'y')] : ['/group']"
               [fragment]="game.tournament.status === 'FINISHED' ? game.group.label : undefined"
               class="btn btn-secondary btn text-white w-100 all-petite-caps" *ngIf="game.group">
                <span class="font-weight-bold">
                    Group {{game.group.label}}
                </span>
                {{game.tournament.created | date:'y'}}
            </a>
        </div>
    </div>

    <div class="alert alert-warning  mt-1" role="alert"
         *ngIf="game.tournament.status === 'FINISHED'">
        <i class="fa fa-warning"></i>
        This game is from a past tournament.
    </div>

    <div class="bet-result mt-4" *ngIf="betResult">
        <div class="bet-result-home" [ngStyle]="{'width': betResult.homeUserPercent + '%'}">
            <ng-template #betsForHome>
                <span *ngFor="let user of betResult.homeUser; let last = last"><cwt-user [username]="user.user.username"></cwt-user><span *ngIf="!last">, </span></span>
            </ng-template>
            <a [routerLink]="" [ngbPopover]="betsForHome" placement="left">
                {{betResult.homeUser.length}}
            </a>
        </div>
        <div class="bet-result-away" [ngStyle]="{'width': betResult.awayUserPercent + '%'}">
            <ng-template #betsForAway>
                <span *ngFor="let user of betResult.awayUser; let last = last"><cwt-user [username]="user.user.username"></cwt-user><span *ngIf="!last">, </span></span>
            </ng-template>
            <a [routerLink]="" [ngbPopover]="betsForAway" placement="right">
                {{betResult.awayUser.length}}
            </a>
        </div>
    </div>

    <div class="row mt-4 no-gutters">
        <div class="col-12 col-md-5 col-lg-4 mb-1 mb-md-0 pr-md-0">
            <div class="btn-group w-100">
                <button class="w-100 btn btn-success text-white" (click)="rate('LIKE')" ngbTooltip="Like"
                        [disabled]="['LIKE', 'DISLIKE'].indexOf(submittingRating) !== -1 || !authenticatedUser || authenticatedUserRatings.indexOf('LIKE') !== -1 || authenticatedUserRatings.indexOf('DISLIKE') !== -1">
                    <i class="fa fa-user" *ngIf="authenticatedUserRatings.indexOf('LIKE') !== -1"></i>&nbsp;
                    <ng-container *ngIf="submittingRating !== 'LIKE'">
                        Like&nbsp;
                        <span class="font-variant-none font-weight-bold">{{ratings.LIKE.length}}</span>
                    </ng-container>
                    <img src="../../img/loading.gif" class="loading" *ngIf="submittingRating === 'LIKE'"/>
                </button>
                <button class="w-100 btn btn-danger text-white" (click)="rate('DISLIKE')"
                        ngbTooltip="Dislike"
                        [disabled]="['LIKE', 'DISLIKE'].indexOf(submittingRating) !== -1 || !authenticatedUser || authenticatedUserRatings.indexOf('DISLIKE') !== -1 || authenticatedUserRatings.indexOf('LIKE') !== -1">
                    <i class="fa fa-user" *ngIf="authenticatedUserRatings.indexOf('DISLIKE') !== -1"></i>&nbsp;
                    <ng-container *ngIf="submittingRating !== 'DISLIKE'">
                        Dislike&nbsp;
                        <span class="font-variant-none font-weight-bold">{{ratings.DISLIKE.length}}</span>
                    </ng-container>
                    <img src="../../img/loading.gif" class="loading" *ngIf="submittingRating === 'DISLIKE'"/>
                </button>
            </div>
        </div>
        <div class="col-12 col-md-5 col-lg-4 mb-1 mb-md-0 pl-md-1 pr-md-1">
            <div class="btn-group w-100">
                <button class="w-100 btn bg-danger text-white" (click)="rate('LIGHTSIDE')"
                        ngbTooltip="Aggressive playing"
                        [disabled]="['LIGHTSIDE', 'DARKSIDE'].indexOf(submittingRating) !== -1 || !authenticatedUser || authenticatedUserRatings.indexOf('LIGHTSIDE') !== -1 || authenticatedUserRatings.indexOf('DARKSIDE') !== -1">
                    <i class="fa fa-user" *ngIf="authenticatedUserRatings.indexOf('LIGHTSIDE') !== -1"></i>&nbsp;
                    <ng-container *ngIf="submittingRating !== 'LIGHTSIDE'">
                        Ligthside&nbsp;
                        <span class="font-variant-none font-weight-bold">{{ratings.LIGHTSIDE.length}}</span>
                    </ng-container>
                    <img src="../../img/loading.gif" class="loading" *ngIf="submittingRating === 'LIGHTSIDE'"/>
                </button>
                <button class="w-100 btn bg-success text-white" (click)="rate('DARKSIDE')"
                        ngbTooltip="Thoughtful playing"
                        [disabled]="['LIGHTSIDE', 'DARKSIDE'].indexOf(submittingRating) !== -1 || !authenticatedUser || authenticatedUserRatings.indexOf('DARKSIDE') !== -1 || authenticatedUserRatings.indexOf('LIGHTSIDE') !== -1">
                    <i class="fa fa-user" *ngIf="authenticatedUserRatings.indexOf('DARKSIDE') !== -1"></i>&nbsp;
                    <ng-container *ngIf="submittingRating !== 'DARKSIDE'">
                        Darkside&nbsp;
                        <span class="font-variant-none font-weight-bold">{{ratings.DARKSIDE.length}}</span>
                    </ng-container>
                    <img src="../../img/loading.gif" class="loading" *ngIf="submittingRating === 'DARKSIDE'"/>
                </button>
            </div>
        </div>
        <div class="col-6 col-md-1 col-lg-2 pr-1 pr-md-0">
            <button class="btn btn-primary btn text-white w-100"
                    [ngClass]="{'active': showRatings}" (click)="showRatings = !showRatings">
                <span class="d-inline d-md-none d-lg-inline">Ratings</span>
                <span class="d-none d-md-inline d-lg-none"><i class="fa fa-star"></i></span>
            </button>
        </div>
        <div class="col-6 col-md-1 col-lg-2 pl-1">
            <a class="btn btn-primary btn text-white w-100"
               [ngClass]="{'disabled': !game.replayExists}" [href]="replayUrl">
                <span class="d-inline d-md-none d-lg-inline">Download</span>
                <span class="d-none d-md-inline d-lg-none"><i class="fa fa-download"></i></span>
            </a>
        </div>
    </div>
    <div [hidden]="!showRatings">
        <div class="row no-gutters popdown">
            <div class="offset-md-10 offset-lg-8 col-6 col-md-1 col-lg-2 text-center pr-1 pr-md-0">
                <i class="fa fa-2x fa-caret-up text-light"></i>
            </div>
        </div>
        <div class="row">
            <div class="col-12 col-md-8 offset-md-3 col-lg-7">
                <div class="card bg-light">
                    <div class="card-body">
                        <div *ngIf="ratings.LIKE.length" class="mb-1">
                            Liked by
                            <span *ngFor="let rating of ratings.LIKE; let last = last">
                                <cwt-user [username]="rating.user.username"></cwt-user><span *ngIf="!last">, </span>
                            </span>
                        </div>
                        <div *ngIf="ratings.DISLIKE.length" class="mb-1">
                            Disliked by
                            <span *ngFor="let rating of ratings.DISLIKE; let last = last">
                                <cwt-user [username]="rating.user.username"></cwt-user><span *ngIf="!last">, </span>
                            </span>
                        </div>
                        <div *ngIf="ratings.LIGHTSIDE.length" class="mb-1">
                            Rated “ligthside” by
                            <span *ngFor="let rating of ratings.LIGHTSIDE; let last = last">
                                <cwt-user [username]="rating.user.username"></cwt-user><span *ngIf="!last">, </span>
                            </span>
                        </div>
                        <div *ngIf="ratings.DARKSIDE.length" class="mb-1">
                            Rated “darkside” by
                            <span *ngFor="let rating of ratings.DARKSIDE; let last = last">
                                <cwt-user [username]="rating.user.username"></cwt-user><span *ngIf="!last">, </span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row mt-4">
        <div class="col-12">
            <div *ngIf="newComment">
                <form #commentForm="ngForm" (ngSubmit)="submitComment()">
                    <textarea rows="3" class="form-control" placeholder="Write a comment…" required
                              [(ngModel)]="newComment.body" name="comment"
                              (keyup.control.enter)="commentForm.onSubmit($event)">
                    </textarea>
                    <div class="float-right">
                        <button class="btn btn-primary mt-1" style="width: 80px"
                                [disabled]="!commentForm.form.valid || submittingComment">
                            <img src="../../img/loading.gif" class="loading" *ngIf="submittingComment"/>
                            <ng-container *ngIf="!submittingComment">Submit</ng-container>
                        </button>
                    </div>
                </form>
                <div class="clearfix"></div>
            </div>
        </div>
    </div>
    <div class="row mt-2">
        <div class="col-12">
            <div class="card bg-secondary text-white border-0">
                <div class="card-body" *ngFor="let comment of game.comments" style="border-bottom: 1px solid white !important;">
                    <cwt-time-ago class="float-right" [date]="comment.created"></cwt-time-ago>
                    <h4 class="card-title">
                        <cwt-user [username]="comment.author.username"></cwt-user>
                    </h4>
                    <p class="card-text rendered-text">{{comment.body}}</p>
                </div>
            </div>
            <div class="alert alert-info" role="alert" *ngIf="!game.comments.length">
                There are no comments yet.
            </div>
        </div>
    </div>
</div>
